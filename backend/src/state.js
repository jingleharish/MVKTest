const { ROOM_CODE_MIN, ROOM_CODE_MAX } = require("./constants");

//----------------------------------------------------------------------------------------------------------------------
// Map of all rooms
//----------------------------------------------------------------------------------------------------------------------

const rooms = new Map();

//----------------------------------------------------------------------------------------------------------------------
// Create a new room
//----------------------------------------------------------------------------------------------------------------------

module.exports.createRoom = (socket, data) => {
    let roomCode = 0;
    do {
        roomCode = `${Math.floor(Math.random() * (ROOM_CODE_MAX - ROOM_CODE_MIN + 1)) + ROOM_CODE_MIN}`;
    } while (rooms.has(roomCode));
    rooms.set(roomCode, { ...data, roomCode, hostSocketId: socket.id, players: [] });
    return roomCode;
};

//----------------------------------------------------------------------------------------------------------------------
// Retrieve a room by its code
//----------------------------------------------------------------------------------------------------------------------

module.exports.getRoom = roomCode => rooms.get(roomCode);

//----------------------------------------------------------------------------------------------------------------------
// Count the number of rooms
//----------------------------------------------------------------------------------------------------------------------

module.exports.getRoomCount = () => rooms.size;

//----------------------------------------------------------------------------------------------------------------------
// Delete a room
//----------------------------------------------------------------------------------------------------------------------

module.exports.deleteRoom = roomCode => rooms.delete(roomCode);

//----------------------------------------------------------------------------------------------------------------------
// Get the host's socket
//----------------------------------------------------------------------------------------------------------------------

module.exports.getHostSocket = (io, roomCode) => {
    const room = rooms.get(roomCode);
    return room && room.hostSocketId ? io.sockets.sockets.get(room.hostSocketId) : undefined;
};
